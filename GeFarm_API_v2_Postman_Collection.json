{
  "info": {
    "name": "Gefarm API v2.2 - Complete & Fixed",
    "_postman_id": "gefarm-api-v22-complete",
    "description": "Collection completa e corretta per Gefarm API v2.2 con tutti i fix implementati",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "https://gefarmdb.altervista.org/gefarm_api_v2",
      "type": "string"
    },
    {
      "key": "token",
      "value": "",
      "type": "string"
    },
    {
      "key": "test_email",
      "value": "test.user@example.com",
      "type": "string"
    },
    {
      "key": "device_id",
      "value": "emcengine-123456",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "üîì Public Endpoints",
      "item": [
        {
          "name": "Test API",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"API is running\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.data.api_status).to.eql('OK');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/test",
              "host": ["{{base_url}}"],
              "path": ["api", "test"]
            }
          }
        },
        {
          "name": "Register User",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('token', jsonData.data.token);",
                  "    ",
                  "    // Auto-update test_email from request body",
                  "    var requestBody = JSON.parse(pm.request.body.raw);",
                  "    pm.collectionVariables.set('test_email', requestBody.email);",
                  "    ",
                  "    console.log('‚úÖ User registered. Token saved. Email verification required.');",
                  "    console.log('Email:', requestBody.email);",
                  "}",
                  "",
                  "pm.test(\"Registration successful\", function () {",
                  "    pm.response.to.have.status(201);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.data.token).to.be.a('string');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{test_email}}\",\n  \"password\": \"Test1234!\",\n  \"nome\": \"Mario\",\n  \"cognome\": \"Rossi\",\n  \"avatar_color\": \"#00853d\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/register",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "register"]
            }
          }
        },
        {
          "name": "Login User",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('token', jsonData.data.token);",
                  "    console.log('‚úÖ Login successful. Token updated.');",
                  "} else if (pm.response.code === 403) {",
                  "    console.log('‚ùå Email not verified. Use verify_email endpoint first.');",
                  "}",
                  "",
                  "pm.test(\"Response is valid\", function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 403]);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{test_email}}\",\n  \"password\": \"Test1234!\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/login",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "login"]
            }
          }
        }
      ]
    },
    {
      "name": "üîÉ Email & Password",
      "item": [
        {
          "name": "Verify Email",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Email verification successful\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{test_email}}\",\n  \"token\": \"12345\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/verify_email",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "verify_email"]
            },
            "description": "‚ö†Ô∏è Replace '12345' with actual 5-digit code from email/logs"
          }
        },
        {
          "name": "Resend Verification Code",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{test_email}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/resend_verification",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "resend_verification"]
            }
          }
        },
        {
          "name": "Request Password Reset",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{test_email}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/password_reset_request",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "password_reset_request"]
            }
          }
        },
        {
          "name": "Confirm Reset Password",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"token\": \"your-reset-token-from-email\",\n  \"new_password\": \"NewPassword123!\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/password_reset_confirm",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "password_reset_confirm"]
            }
          }
        }
      ]
    },
    {
      "name": "üîí User Endpoints",
      "item": [
        {
          "name": "Get Profile",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Profile retrieved\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data).to.have.property('email');",
                  "    pm.expect(jsonData.data).to.have.property('nome');",
                  "    pm.expect(jsonData.data).to.have.property('cognome');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{token}}"}
            ],
            "url": {
              "raw": "{{base_url}}/api/user/profile",
              "host": ["{{base_url}}"],
              "path": ["api", "user", "profile"]
            }
          }
        },
        {
          "name": "Update Profile",
          "request": {
            "method": "PUT",
            "header": [
              {"key": "Content-Type", "value": "application/json"},
              {"key": "Authorization", "value": "Bearer {{token}}"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"nome\": \"Mario\",\n  \"cognome\": \"Rossi Updated\",\n  \"avatar_color\": \"#FF5733\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/user/update_profile",
              "host": ["{{base_url}}"],
              "path": ["api", "user", "update_profile"]
            }
          }
        }
      ]
    },
    {
      "name": "üì± Device Endpoints",
      "item": [
        {
          "name": "Register New Device",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    var requestBody = JSON.parse(pm.request.body.raw);",
                  "    pm.collectionVariables.set('device_id', requestBody.device_id);",
                  "    console.log('‚úÖ Device registered:', requestBody.device_id);",
                  "}",
                  "",
                  "pm.test(\"Device registered successfully\", function () {",
                  "    pm.response.to.have.status(201);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.device).to.have.property('device_id');",
                  "    pm.expect(jsonData.data.association).to.have.property('is_meter_owner');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Content-Type", "value": "application/json"},
              {"key": "Authorization", "value": "Bearer {{token}}"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"device_id\": \"{{device_id}}\",\n  \"device_family\": \"emc\",\n  \"device_type\": \"emcengine\",\n  \"nome_dispositivo\": \"Il mio EMC Engine\",\n  \"firmware_version\": \"1.0.0\",\n  \"nickname\": \"Casa principale\",\n  \"is_meter_owner\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/devices/register",
              "host": ["{{base_url}}"],
              "path": ["api", "devices", "register"]
            }
          }
        },
        {
          "name": "Add Existing Device",
          "request": {
            "method": "POST",
            "header": [
              {"key": "Content-Type", "value": "application/json"},
              {"key": "Authorization", "value": "Bearer {{token}}"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"device_id\": \"emcengine-999999\",\n  \"role\": \"user\",\n  \"nickname\": \"Dispositivo condiviso\",\n  \"is_meter_owner\": false\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/devices/add",
              "host": ["{{base_url}}"],
              "path": ["api", "devices", "add"]
            }
          }
        },
        {
          "name": "List User Devices",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Devices list retrieved\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.devices).to.be.an('array');",
                  "    ",
                  "    if (jsonData.data.devices.length > 0) {",
                  "        pm.test(\"Device has is_meter_owner flag\", function () {",
                  "            pm.expect(jsonData.data.devices[0]).to.have.property('is_meter_owner');",
                  "        });",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{token}}"}
            ],
            "url": {
              "raw": "{{base_url}}/api/devices/list",
              "host": ["{{base_url}}"],
              "path": ["api", "devices", "list"]
            }
          }
        },
        {
          "name": "Get Device Details",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Device details retrieved\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.device).to.have.property('device_id');",
                  "    pm.expect(jsonData.data.device).to.have.property('is_meter_owner');",
                  "    ",
                  "    pm.test(\"is_meter_owner is boolean\", function () {",
                  "        pm.expect(jsonData.data.device.is_meter_owner).to.be.a('boolean');",
                  "    });",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{token}}"}
            ],
            "url": {
              "raw": "{{base_url}}/api/devices/details?device_id={{device_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "devices", "details"],
              "query": [
                {"key": "device_id", "value": "{{device_id}}"}
              ]
            }
          }
        }
      ]
    },
    {
      "name": "‚ö° Meter Data (Chain2)",
      "item": [
        {
          "name": "Submit Meter Data",
          "request": {
            "method": "POST",
            "header": [
              {"key": "Content-Type", "value": "application/json"},
              {"key": "Authorization", "value": "Bearer {{token}}"}
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"device_id\": \"{{device_id}}\",\n  \"cf\": \"RSSMRA80A01H501U\",\n  \"nome\": \"Mario\",\n  \"cognome\": \"Rossi\",\n  \"indirizzo\": \"Via Roma 123\",\n  \"zip_code\": \"00100\",\n  \"citta\": \"Roma\",\n  \"provincia\": \"RM\",\n  \"pod\": \"IT001E12345678\",\n  \"email\": \"mario.rossi@test.com\",\n  \"telefono\": \"3451234567\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/meter/submit",
              "host": ["{{base_url}}"],
              "path": ["api", "meter", "submit"]
            }
          }
        },
        {
          "name": "Get Active Meter Data",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Meter data retrieved\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    ",
                  "    if (jsonData.data.meter_data) {",
                  "        pm.expect(jsonData.data).to.have.property('is_meter_owner');",
                  "        pm.test(\"CF visible only if meter owner\", function () {",
                  "            if (jsonData.data.is_meter_owner) {",
                  "                pm.expect(jsonData.data).to.have.property('codice_fiscale_owner');",
                  "            }",
                  "        });",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {"key": "Authorization", "value": "Bearer {{token}}"}
            ],
            "url": {
              "raw": "{{base_url}}/api/meter/active?device_id={{device_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "meter", "active"],
              "query": [
                {"key": "device_id", "value": "{{device_id}}"}
              ]
            }
          }
        }
      ]
    },
    {
      "name": "üêõ Debug Endpoints",
      "item": [
        {
          "name": "Database Structure",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/debug/database_structure",
              "host": ["{{base_url}}"],
              "path": ["api", "debug", "database_structure"]
            },
            "description": "‚ö†Ô∏è DISABLE IN PRODUCTION"
          }
        },
        {
          "name": "User Devices Associations",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/debug/user_devices",
              "host": ["{{base_url}}"],
              "path": ["api", "debug", "user_devices"]
            },
            "description": "‚ö†Ô∏è Path corrected from api/devices/user_devices"
          }
        }
      ]
    }
  ]
}
